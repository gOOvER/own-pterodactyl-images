name: ðŸ—ï¸ Build & Test Images

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/Dockerfile'
      - '**/entrypoint.sh'
  pull_request:
    branches: [ main ]
    paths:
      - '**/Dockerfile'
      - '**/entrypoint.sh'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    name: ðŸ” Detect Changed Images
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.any }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          list-files: json
          filters: |
            any:
              - '**/Dockerfile'
              - '**/entrypoint.sh'

      - name: Create build matrix
        id: matrix
        if: steps.changes.outputs.any == 'true'
        run: |
          # Get changed directories
          CHANGED_FILES='${{ steps.changes.outputs.any_files }}'
          echo "Changed files: $CHANGED_FILES"
          
          # Extract unique directories containing Dockerfiles
          DIRS=$(echo '${{ steps.changes.outputs.any_files }}' | jq -r '.[]' | xargs dirname | sort -u)
          
          # Find Dockerfiles in changed directories
          MATRIX="[]"
          for dir in $DIRS; do
            if [ -f "$dir/Dockerfile" ]; then
              # Determine image type and name
              IMAGE_TYPE=$(echo "$dir" | cut -d'/' -f1)
              IMAGE_NAME=$(echo "$dir" | cut -d'/' -f2- | tr '/' '-')
              
              MATRIX=$(echo "$MATRIX" | jq --arg dir "$dir" --arg type "$IMAGE_TYPE" --arg name "$IMAGE_NAME" \
                '. += [{"context": $dir, "dockerfile": ($dir + "/Dockerfile"), "image_type": $type, "image_name": $name, "full_name": ($type + "-" + $name)}]')
            fi
          done
          
          echo "Build matrix: $MATRIX"
          echo "matrix=$(echo "$MATRIX" | jq -c .)" >> $GITHUB_OUTPUT

  build-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.full_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/${{ matrix.full_name }}.tar

      - name: Load and test image
        run: |
          # Load the built image
          docker load --input /tmp/${{ matrix.full_name }}.tar
          
          # Get the first tag for testing
          IMAGE_TAG=$(echo '${{ steps.meta.outputs.tags }}' | head -n1)
          echo "Testing image: $IMAGE_TAG"
          
          # Basic smoke tests
          echo "ðŸ§ª Running smoke tests..."
          
          # Test 1: Image starts without errors
          echo "Test 1: Container startup test"
          timeout 30s docker run --rm --name test-${{ matrix.full_name }}-startup \
            -e STARTUP="echo 'Test startup command'" \
            "$IMAGE_TAG" echo "Startup test passed" || {
            echo "âŒ Startup test failed"
            exit 1
          }
          
          # Test 2: Entrypoint script exists and is executable
          echo "Test 2: Entrypoint script test"
          if [ -f "${{ matrix.context }}/entrypoint.sh" ]; then
            docker run --rm "$IMAGE_TAG" test -x /entrypoint.sh || {
              echo "âŒ Entrypoint script is not executable"
              exit 1
            }
            echo "âœ… Entrypoint script is executable"
          fi
          
          # Test 3: Required directories exist
          echo "Test 3: Directory structure test"
          docker run --rm "$IMAGE_TAG" test -d /home/container || {
            echo "âŒ /home/container directory missing"
            exit 1
          }
          echo "âœ… Container directory structure is correct"
          
          # Test 4: Container user exists
          echo "Test 4: User test"
          docker run --rm "$IMAGE_TAG" id container || {
            echo "âŒ Container user does not exist"
            exit 1
          }
          echo "âœ… Container user exists"
          
          echo "ðŸŽ‰ All smoke tests passed for ${{ matrix.full_name }}"

      - name: Test specific game requirements
        run: |
          IMAGE_TAG=$(echo '${{ steps.meta.outputs.tags }}' | head -n1)
          
          echo "ðŸŽ® Testing game-specific requirements for ${{ matrix.image_type }}/${{ matrix.image_name }}"
          
          case "${{ matrix.image_type }}" in
            "java")
              echo "â˜• Testing Java environment"
              docker run --rm "$IMAGE_TAG" java -version || {
                echo "âŒ Java not available"
                exit 1
              }
              echo "âœ… Java is available"
              ;;
            "nodejs"|"bots")
              echo "ðŸ“¦ Testing Node.js environment"
              docker run --rm "$IMAGE_TAG" node --version || {
                echo "âŒ Node.js not available"
                exit 1
              }
              echo "âœ… Node.js is available"
              ;;
            "python")
              echo "ðŸ Testing Python environment"
              docker run --rm "$IMAGE_TAG" python3 --version || {
                echo "âŒ Python not available"
                exit 1
              }
              echo "âœ… Python is available"
              ;;
            "database")
              echo "ðŸ—„ï¸ Testing database environment"
              # Database-specific tests would go here
              echo "âœ… Database environment ready"
              ;;
            *)
              echo "â„¹ï¸ No specific tests for image type: ${{ matrix.image_type }}"
              ;;
          esac

      - name: Security scan of built image
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/${{ matrix.full_name }}.tar
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Push image (if not PR)
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate build report
        run: |
          echo "# ðŸ—ï¸ Build Report: ${{ matrix.full_name }}" > build-report-${{ matrix.full_name }}.md
          echo "" >> build-report-${{ matrix.full_name }}.md
          echo "**Image:** ${{ matrix.full_name }}" >> build-report-${{ matrix.full_name }}.md
          echo "**Context:** ${{ matrix.context }}" >> build-report-${{ matrix.full_name }}.md
          echo "**Type:** ${{ matrix.image_type }}" >> build-report-${{ matrix.full_name }}.md
          echo "**Built:** $(date)" >> build-report-${{ matrix.full_name }}.md
          echo "" >> build-report-${{ matrix.full_name }}.md
          echo "## ðŸ·ï¸ Tags" >> build-report-${{ matrix.full_name }}.md
          echo '```' >> build-report-${{ matrix.full_name }}.md
          echo '${{ steps.meta.outputs.tags }}' >> build-report-${{ matrix.full_name }}.md
          echo '```' >> build-report-${{ matrix.full_name }}.md
          echo "" >> build-report-${{ matrix.full_name }}.md
          echo "## âœ… Tests Passed" >> build-report-${{ matrix.full_name }}.md
          echo "- ðŸš€ Container startup" >> build-report-${{ matrix.full_name }}.md
          echo "- ðŸ“ Directory structure" >> build-report-${{ matrix.full_name }}.md
          echo "- ðŸ‘¤ Container user" >> build-report-${{ matrix.full_name }}.md
          echo "- ðŸŽ® Game-specific requirements" >> build-report-${{ matrix.full_name }}.md
          echo "- ðŸ”’ Security scan" >> build-report-${{ matrix.full_name }}.md

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ matrix.full_name }}
          path: build-report-${{ matrix.full_name }}.md
          retention-days: 7

  notify-success:
    name: ðŸŽ‰ Build Success Notification
    runs-on: ubuntu-latest
    needs: [detect-changes, build-test]
    if: needs.detect-changes.outputs.has-changes == 'true' && success()
    steps:
      - name: Success notification
        run: |
          echo "ðŸŽ‰ All images built and tested successfully!"
          echo "âœ… Ready for deployment to Pelican GamePanel"