name: üìã Documentation Update

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '**/Dockerfile'
      - '**/entrypoint.sh'
  workflow_dispatch:

jobs:
  update-readme:
    name: üìù Update Main README
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Image Overview
        run: |
          echo "# üéÆ Pelican GamePanel Docker Images" > GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "This repository contains optimized Docker images for the Pelican GamePanel." >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "## üìä Image Statistics" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          # Count images by category
          TOTAL_IMAGES=$(find . -name "Dockerfile" | wc -l)
          echo "**Total Images:** $TOTAL_IMAGES" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          # Count by category
          for category in alpine apps bots custom database dev distros games installers java steam steamcmd voice wine; do
            if [ -d "$category" ]; then
              COUNT=$(find "$category" -name "Dockerfile" | wc -l)
              if [ $COUNT -gt 0 ]; then
                echo "- **$category:** $COUNT images" >> GENERATED_README.md
              fi
            fi
          done
          
          echo "" >> GENERATED_README.md
          echo "## üèóÔ∏è Available Images" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          # Generate table of images
          echo "| Category | Image | Description | Base |" >> GENERATED_README.md
          echo "|----------|-------|-------------|------|" >> GENERATED_README.md
          
          for category in alpine apps bots custom database dev distros games installers java steam steamcmd voice wine; do
            if [ -d "$category" ]; then
              find "$category" -name "Dockerfile" | while read -r dockerfile; do
                dir=$(dirname "$dockerfile")
                image_name=$(basename "$dir")
                base_image="Unknown"
                
                # Extract base image
                if [ -f "$dockerfile" ]; then
                  base_image=$(grep -E "^FROM " "$dockerfile" | head -1 | awk '{print $2}' | cut -d':' -f1)
                fi
                
                echo "| $category | $image_name | Game/Application Image | $base_image |" >> GENERATED_README.md
              done
            fi
          done
          
          echo "" >> GENERATED_README.md
          echo "## üöÄ Quick Start" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "### Using with Pelican Panel" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "1. Import the egg configuration" >> GENERATED_README.md
          echo "2. Set the Docker image to: \`ghcr.io/goover/pelican-images/<category>-<name>:latest\`" >> GENERATED_README.md
          echo "3. Configure your server settings" >> GENERATED_README.md
          echo "4. Start your server!" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "### Manual Docker Usage" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "\`\`\`bash" >> GENERATED_README.md
          echo "docker run -d \\" >> GENERATED_README.md
          echo "  --name my-game-server \\" >> GENERATED_README.md
          echo "  -p 25565:25565 \\" >> GENERATED_README.md
          echo "  -v /path/to/data:/home/container \\" >> GENERATED_README.md
          echo "  -e STARTUP=\"your startup command\" \\" >> GENERATED_README.md
          echo "  ghcr.io/goover/pelican-images/category-name:latest" >> GENERATED_README.md
          echo "\`\`\`" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "## üîí Security & Updates" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "- üîÑ Images are automatically updated weekly" >> GENERATED_README.md
          echo "- üõ°Ô∏è Regular security scans with Trivy" >> GENERATED_README.md
          echo "- üìã Automated quality checks with Hadolint" >> GENERATED_README.md
          echo "- üß™ Comprehensive testing before release" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "## üìö Documentation" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "- [GitHub Actions Workflows](.github/README.md)" >> GENERATED_README.md
          echo "- [Contributing Guidelines](CONTRIBUTING.md)" >> GENERATED_README.md
          echo "- [License](LICENSE)" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "## ü§ù Support" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "- üí¨ Discord: https://discord.goover.dev" >> GENERATED_README.md
          echo "- üíñ Donate: https://donate.goover.dev" >> GENERATED_README.md
          echo "- üìß Issues: Use GitHub Issues for bug reports" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "## üìÑ License" >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          echo "This project is licensed under the AGPLv3 License - see the [LICENSE](LICENSE) file for details." >> GENERATED_README.md
          echo "" >> GENERATED_README.md
          
          echo "---" >> GENERATED_README.md
          echo "*Last updated: $(date)*" >> GENERATED_README.md

      - name: Update main README if needed
        run: |
          if [ -f "README.md" ]; then
            # Keep existing README if it has custom content
            echo "Existing README.md found, creating IMAGES.md instead"
            mv GENERATED_README.md IMAGES.md
          else
            # Use generated README as main README
            mv GENERATED_README.md README.md
          fi

      - name: Create/Update CONTRIBUTING.md
        run: |
          cat > CONTRIBUTING.md << 'EOF'
          # ü§ù Contributing to Pelican GamePanel Images
          
          Thank you for your interest in contributing! This guide will help you get started.
          
          ## üöÄ Quick Start
          
          1. Fork this repository
          2. Create a feature branch: `git checkout -b feature/new-image`
          3. Make your changes
          4. Test locally: `docker build -f path/to/Dockerfile .`
          5. Commit and push: `git commit -am "Add new image for XYZ"`
          6. Create a Pull Request
          
          ## üìÅ Repository Structure
          
          ```
          ‚îú‚îÄ‚îÄ category/               # Image category (games, bots, etc.)
          ‚îÇ   ‚îú‚îÄ‚îÄ image-name/         # Specific image
          ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile      # Docker build instructions
          ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh   # Container startup script
          ‚îÇ   ‚îî‚îÄ‚îÄ ...
          ‚îú‚îÄ‚îÄ .github/
          ‚îÇ   ‚îî‚îÄ‚îÄ workflows/          # CI/CD pipelines
          ‚îî‚îÄ‚îÄ README.md
          ```
          
          ## üê≥ Creating New Images
          
          ### 1. Choose the Right Category
          
          - `alpine/` - Alpine Linux based images
          - `apps/` - Application servers
          - `bots/` - Discord/game bots
          - `database/` - Database servers
          - `dev/` - Development environments
          - `games/` - Game servers
          - `java/` - Java applications
          
          ### 2. Dockerfile Guidelines
          
          ```dockerfile
          # Use specific version tags, not :latest
          FROM ubuntu:22.04
          
          # Set maintainer info
          LABEL maintainer="gOOvER <goover@discord.com>"
          LABEL org.opencontainers.image.source="https://github.com/goover/own-pterodactyl-images"
          
          # Create container user for Pelican compatibility
          RUN useradd -d /home/container -m container
          
          # Install packages (pin versions when possible)
          RUN apt-get update && apt-get install -y \
              package1=1.2.3 \
              package2 \
              && apt-get clean \
              && rm -rf /var/lib/apt/lists/*
          
          # Set working directory
          WORKDIR /home/container
          
          # Copy entrypoint script
          COPY entrypoint.sh /entrypoint.sh
          RUN chmod +x /entrypoint.sh
          
          # Switch to container user
          USER container
          
          # Set entrypoint
          ENTRYPOINT ["/entrypoint.sh"]
          ```
          
          ### 3. Entrypoint Script Guidelines
          
          ```bash
          #!/bin/bash
          set -e
          
          # Change to container directory
          cd /home/container
          
          # Set timezone
          export TZ=${TZ:-UTC}
          
          # Process STARTUP command (Pelican specific)
          MODIFIED_STARTUP=$(echo -e "${STARTUP}" | sed -e 's/{{/${/g' -e 's/}}/}/g')
          
          # Execute the startup command
          exec bash -c "${MODIFIED_STARTUP}"
          ```
          
          ## ‚úÖ Testing Guidelines
          
          ### Local Testing
          
          ```bash
          # Build the image
          docker build -t test-image:latest .
          
          # Test basic functionality
          docker run --rm -it \
            -e STARTUP="echo 'Hello World'" \
            test-image:latest
          
          # Test with volume mount
          docker run --rm -it \
            -v $(pwd)/test-data:/home/container \
            -e STARTUP="ls -la" \
            test-image:latest
          ```
          
          ### Automated Testing
          
          The CI/CD pipeline will automatically:
          - Build your image for AMD64 and ARM64
          - Run security scans with Trivy
          - Perform smoke tests
          - Check Dockerfile with Hadolint
          - Validate shell scripts with ShellCheck
          
          ## üîí Security Best Practices
          
          1. **Use specific base image tags**
          2. **Pin package versions where possible**
          3. **Run as non-root user (container)**
          4. **Clean package manager caches**
          5. **Don't store secrets in images**
          6. **Use COPY instead of ADD**
          7. **Minimize layer count**
          
          ## üìã Code Style
          
          ### Shell Scripts
          - Use `#!/bin/bash` shebang
          - Include `set -e` for error handling
          - Quote variables: `"$VARIABLE"`
          - Use meaningful function names
          - Add comments for complex logic
          
          ### Dockerfiles
          - Group RUN commands to minimize layers
          - Sort multi-line arguments alphabetically
          - Use specific versions for base images
          - Add labels for metadata
          - Clean up in the same RUN command
          
          ## üß™ Pull Request Process
          
          1. **Description**: Clearly describe what your PR does
          2. **Testing**: Include testing steps
          3. **Screenshots**: For UI changes (if applicable)
          4. **Breaking Changes**: Clearly mark any breaking changes
          5. **Documentation**: Update docs if needed
          
          ### PR Template
          
          ```markdown
          ## üìù Description
          Brief description of changes
          
          ## üéØ Type of Change
          - [ ] New image
          - [ ] Bug fix
          - [ ] Security update
          - [ ] Documentation update
          
          ## üß™ Testing
          - [ ] Built locally
          - [ ] Tested basic functionality
          - [ ] Checked for security issues
          
          ## üìã Checklist
          - [ ] Dockerfile follows guidelines
          - [ ] Entrypoint script is executable
          - [ ] Container user is properly configured
          - [ ] Documentation updated (if needed)
          ```
          
          ## üêõ Reporting Issues
          
          When reporting issues, please include:
          - Image name and tag
          - Steps to reproduce
          - Expected vs actual behavior
          - Error messages (if any)
          - Environment details
          
          ## üìö Resources
          
          - [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
          - [Pelican Panel Documentation](https://pelican.dev/)
          - [Container Security](https://docs.docker.com/develop/security-best-practices/)
          - [Dockerfile Reference](https://docs.docker.com/engine/reference/builder/)
          
          ## ü§ù Community
          
          - üí¨ Discord: https://discord.goover.dev
          - üíñ Donate: https://donate.goover.dev
          - üìß Email: Contact via GitHub Issues
          
          ## üìÑ License
          
          By contributing, you agree that your contributions will be licensed under the AGPLv3 License.
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "üìù Auto-update documentation [skip ci]" || echo "No changes to commit"
            git push || echo "No changes to push"
          fi