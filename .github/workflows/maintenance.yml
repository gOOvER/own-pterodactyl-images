name: üìÖ Scheduled Maintenance

on:
  schedule:
    # Run every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images'
        required: false
        default: false
        type: boolean

jobs:
  check-base-images:
    name: üîç Check Base Image Updates
    runs-on: ubuntu-latest
    outputs:
      updates-available: ${{ steps.check.outputs.updates }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for base image updates
        id: check
        run: |
          echo "üîç Checking for base image updates..."
          
          # Create array to store images that need updates
          UPDATES_NEEDED="[]"
          
          # Find all Dockerfiles
          find . -name "Dockerfile" | while read -r dockerfile; do
            echo "üìÑ Checking: $dockerfile"
            
            # Extract FROM statements
            grep -E "^FROM " "$dockerfile" | while read -r from_line; do
              BASE_IMAGE=$(echo "$from_line" | awk '{print $2}')
              echo "  Base image: $BASE_IMAGE"
              
              # Skip scratch and other special bases
              if [[ "$BASE_IMAGE" == "scratch" || "$BASE_IMAGE" == *"@sha256"* ]]; then
                continue
              fi
              
              # Check if image has updates (simplified check)
              if [[ "$BASE_IMAGE" != *":latest"* ]]; then
                echo "  ‚ÑπÔ∏è Using pinned version: $BASE_IMAGE"
                
                # Extract image name and tag
                IMAGE_NAME=$(echo "$BASE_IMAGE" | cut -d':' -f1)
                CURRENT_TAG=$(echo "$BASE_IMAGE" | cut -d':' -f2)
                
                # For common base images, suggest newer versions
                case "$IMAGE_NAME" in
                  "ubuntu")
                    if [[ "$CURRENT_TAG" < "22.04" ]]; then
                      echo "  üìà Newer Ubuntu version available: ubuntu:22.04"
                    fi
                    ;;
                  "alpine")
                    if [[ "$CURRENT_TAG" < "3.18" ]]; then
                      echo "  üìà Newer Alpine version available: alpine:3.18"
                    fi
                    ;;
                  "debian")
                    if [[ "$CURRENT_TAG" == "bullseye"* || "$CURRENT_TAG" == "buster"* ]]; then
                      echo "  üìà Newer Debian version available: debian:bookworm"
                    fi
                    ;;
                  "node")
                    # Check for Node.js LTS versions
                    if [[ "$CURRENT_TAG" =~ ^[0-9]+\. ]] && [[ "${CURRENT_TAG%%.*}" -lt "20" ]]; then
                      echo "  üìà Newer Node.js LTS available: node:20-alpine"
                    fi
                    ;;
                  "openjdk"|"eclipse-temurin")
                    if [[ "$CURRENT_TAG" =~ ^[0-9]+ ]] && [[ "${CURRENT_TAG%%.*}" -lt "21" ]]; then
                      echo "  üìà Newer Java version available: Consider Java 21"
                    fi
                    ;;
                esac
              fi
            done
          done
          
          echo "updates=true" >> $GITHUB_OUTPUT

      - name: Create maintenance matrix
        id: matrix
        run: |
          # Find all directories with Dockerfiles for maintenance
          DOCKERFILES=$(find . -name "Dockerfile" | head -30)  # Limit to prevent excessive jobs
          
          if [ -z "$DOCKERFILES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            MATRIX=$(echo "$DOCKERFILES" | jq -R -s -c 'split("\n")[:-1] | map({
              dockerfile: .,
              context: (. | split("/")[:-1] | join("/") // "."),
              name: (. | split("/")[1:-1] | join("-") // "root")
            })')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  security-updates:
    name: üîí Security Updates Check
    runs-on: ubuntu-latest
    needs: check-base-images
    strategy:
      matrix:
        include: ${{ fromJson(needs.check-base-images.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and scan for vulnerabilities
        run: |
          DOCKERFILE="${{ matrix.dockerfile }}"
          CONTEXT="${{ matrix.context }}"
          IMAGE_TAG="security-scan-${{ matrix.name }}:latest"
          
          echo "üîç Building image for security scan: $IMAGE_TAG"
          
          # Build image
          if ! docker build -f "$DOCKERFILE" -t "$IMAGE_TAG" "$CONTEXT"; then
            echo "‚ùå Failed to build image from $DOCKERFILE"
            exit 1
          fi
          
          echo "üõ°Ô∏è Running security scan..."
          
          # Run Trivy scan
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $PWD:/workspace \
            aquasec/trivy:latest image \
            --format table \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            "$IMAGE_TAG" || {
            echo "üö® Critical or high severity vulnerabilities found!"
            echo "SECURITY_ISSUES=true" >> $GITHUB_ENV
          }

      - name: Generate security report
        if: env.SECURITY_ISSUES == 'true'
        run: |
          echo "üö® Security issues found in ${{ matrix.name }}" >> security-issues.txt
          echo "Dockerfile: ${{ matrix.dockerfile }}" >> security-issues.txt
          echo "Scan date: $(date)" >> security-issues.txt
          echo "---" >> security-issues.txt

      - name: Upload security issues
        if: env.SECURITY_ISSUES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-issues-${{ matrix.name }}
          path: security-issues.txt

  dependency-updates:
    name: üì¶ Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check package.json files
        run: |
          echo "üì¶ Checking Node.js dependencies..."
          
          find . -name "package.json" | while read -r package_file; do
            echo "üìÑ Checking: $package_file"
            
            # Check for outdated dependencies (requires npm)
            if command -v npm >/dev/null; then
              cd "$(dirname "$package_file")"
              npm outdated || echo "Some packages may be outdated in $package_file"
              cd - >/dev/null
            fi
          done

      - name: Check Python requirements
        run: |
          echo "üêç Checking Python dependencies..."
          
          find . -name "requirements.txt" -o -name "requirements*.txt" | while read -r req_file; do
            echo "üìÑ Checking: $req_file"
            
            # Look for pinned versions
            if grep -E "==" "$req_file" >/dev/null; then
              echo "  ‚úÖ Pinned versions found"
            else
              echo "  ‚ö†Ô∏è Consider pinning package versions"
            fi
            
            # Check for known vulnerable packages (basic examples)
            if grep -E "(django<3|flask<2|requests<2.20)" "$req_file"; then
              echo "  üö® Potentially vulnerable packages detected"
            fi
          done

      - name: Check Dockerfile package versions
        run: |
          echo "üê≥ Checking Dockerfile package installations..."
          
          find . -name "Dockerfile" | while read -r dockerfile; do
            echo "üìÑ Checking: $dockerfile"
            
            # Check for package installations without version pinning
            if grep -E "(apt-get install|apk add|yum install)" "$dockerfile" | grep -v -E "(=|@|:)" | head -5; then
              echo "  ‚ö†Ô∏è Unpinned packages found in $dockerfile"
            fi
            
            # Check for deprecated base images
            if grep "FROM.*ubuntu:18.04\|FROM.*debian:stretch\|FROM.*alpine:3.1[0-3]" "$dockerfile"; then
              echo "  üö® Deprecated base image detected in $dockerfile"
            fi
          done

  generate-maintenance-report:
    name: üìä Generate Maintenance Report
    runs-on: ubuntu-latest
    needs: [check-base-images, security-updates, dependency-updates]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download security artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: security-issues-*
          merge-multiple: true
        continue-on-error: true

      - name: Generate maintenance report
        run: |
          echo "# üìÖ Scheduled Maintenance Report" > maintenance-report.md
          echo "" >> maintenance-report.md
          echo "**Date:** $(date)" >> maintenance-report.md
          echo "**Repository:** ${{ github.repository }}" >> maintenance-report.md
          echo "" >> maintenance-report.md
          
          echo "## üîç Maintenance Summary" >> maintenance-report.md
          echo "" >> maintenance-report.md
          echo "| Check | Status |" >> maintenance-report.md
          echo "|-------|--------|" >> maintenance-report.md
          echo "| Base Images | ${{ needs.check-base-images.result }} |" >> maintenance-report.md
          echo "| Security Updates | ${{ needs.security-updates.result }} |" >> maintenance-report.md
          echo "| Dependencies | ${{ needs.dependency-updates.result }} |" >> maintenance-report.md
          echo "" >> maintenance-report.md
          
          echo "## üö® Security Issues" >> maintenance-report.md
          if ls security-issues-*.txt 1> /dev/null 2>&1; then
            echo "Security issues were found in the following images:" >> maintenance-report.md
            echo "" >> maintenance-report.md
            for file in security-issues-*.txt; do
              echo "### $(basename "$file" .txt)" >> maintenance-report.md
              echo '```' >> maintenance-report.md
              cat "$file" >> maintenance-report.md
              echo '```' >> maintenance-report.md
              echo "" >> maintenance-report.md
            done
          else
            echo "‚úÖ No critical security issues found." >> maintenance-report.md
          fi
          echo "" >> maintenance-report.md
          
          echo "## üìù Recommendations" >> maintenance-report.md
          echo "- üîÑ Update base images to latest stable versions" >> maintenance-report.md
          echo "- üì¶ Pin package versions for reproducible builds" >> maintenance-report.md
          echo "- üîí Address any security vulnerabilities found" >> maintenance-report.md
          echo "- üßπ Remove deprecated packages and dependencies" >> maintenance-report.md
          echo "- üìã Review and update documentation" >> maintenance-report.md
          echo "" >> maintenance-report.md
          
          echo "## üîó Useful Links" >> maintenance-report.md
          echo "- [Docker Hub Official Images](https://hub.docker.com/_/)" >> maintenance-report.md
          echo "- [Pelican Panel Documentation](https://pelican.dev/)" >> maintenance-report.md
          echo "- [Security Best Practices](https://docs.docker.com/develop/security-best-practices/)" >> maintenance-report.md

      - name: Upload maintenance report
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-report-${{ github.run_number }}
          path: maintenance-report.md
          retention-days: 90

      - name: Create issue for critical issues
        if: contains(needs.security-updates.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reportContent = "# üö® Critical Security Issues Found\n\n";
            reportContent += "The scheduled maintenance scan has found critical security issues that require immediate attention.\n\n";
            reportContent += "**Scan Date:** " + new Date().toISOString() + "\n";
            reportContent += "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n";
            
            try {
              const maintenanceReport = fs.readFileSync('maintenance-report.md', 'utf8');
              reportContent += maintenanceReport;
            } catch (error) {
              reportContent += "Could not read full maintenance report. Please check the workflow artifacts.\n";
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Critical Security Issues - ${new Date().toDateString()}`,
              body: reportContent,
              labels: ['security', 'maintenance', 'high-priority']
            });

  cleanup:
    name: üßπ Cleanup Old Artifacts
    runs-on: ubuntu-latest
    needs: [generate-maintenance-report]
    if: always()
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              
              if (createdAt < thirtyDaysAgo && 
                  (artifact.name.includes('security-') || 
                   artifact.name.includes('maintenance-') ||
                   artifact.name.includes('build-report-'))) {
                
                console.log(`Deleting old artifact: ${artifact.name}`);
                
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                } catch (error) {
                  console.log(`Failed to delete artifact ${artifact.name}: ${error.message}`);
                }
              }
            }