name: ðŸ”’ Security & Quality Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 06:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.changes.outputs.dockerfiles }}
      scripts: ${{ steps.changes.outputs.scripts }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          list-files: shell
          filters: |
            dockerfiles:
              - '**/Dockerfile'
              - '**/dockerfile'
              - '**/Dockerfile.*'
            scripts:
              - '**/entrypoint.sh'
              - '**/*.sh'

      - name: Create build matrix
        id: matrix
        run: |
          # Find all Dockerfiles and create matrix
          DOCKERFILES=$(find . -name "Dockerfile" -o -name "dockerfile" | head -20)
          
          if [ -z "$DOCKERFILES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            MATRIX=$(echo "$DOCKERFILES" | jq -R -s -c 'split("\n")[:-1] | map({dockerfile: ., context: (. | split("/")[:-1] | join("/") // ".")})')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  shellcheck-audit:
    name: ðŸš ShellCheck Audit
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true' || github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          format: gcc
          severity: error
        env:
          SHELLCHECK_OPTS: -e SC1091 -e SC2034

  dockerfile-audit:
    name: ðŸ³ Dockerfile Security Audit
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.dockerfiles == 'true' || github.event_name == 'schedule'
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Hadolint (Dockerfile Linter)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
          format: sarif
          output-file: hadolint-results.sarif
          no-color: true
          failure-threshold: warning

      - name: Upload Hadolint SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif

  vulnerability-scan:
    name: ðŸ›¡ï¸ Vulnerability Scanning
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.dockerfiles == 'true' || github.event_name == 'schedule'
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and scan Docker image
        run: |
          DOCKERFILE="${{ matrix.dockerfile }}"
          CONTEXT="${{ matrix.context }}"
          SAFE_NAME=$(echo "$DOCKERFILE" | tr '/' '-' | tr '.' '-')
          IMAGE_TAG="scan-${SAFE_NAME}:${{ github.sha }}"
          
          echo "Building and scanning: $IMAGE_TAG"
          
          # Build image
          docker build -f "$DOCKERFILE" -t "$IMAGE_TAG" "$CONTEXT" || {
            echo "âŒ Build failed for $DOCKERFILE"
            exit 1
          }
          
          # Run Trivy scan
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format table \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "$IMAGE_TAG"

  generate-report:
    name: ðŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    needs: [shellcheck-audit, dockerfile-audit, vulnerability-scan]
    if: always()
    steps:
      - name: Generate Summary Report
        run: |
          echo "# ðŸ”’ Security & Quality Audit Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ“Š Job Status" >> security-report.md
          echo "| Job | Status |" >> security-report.md
          echo "|-----|--------|" >> security-report.md
          echo "| ShellCheck | ${{ needs.shellcheck-audit.result }} |" >> security-report.md
          echo "| Dockerfile Audit | ${{ needs.dockerfile-audit.result }} |" >> security-report.md
          echo "| Vulnerability Scan | ${{ needs.vulnerability-scan.result }} |" >> security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.sha }}
          path: security-report.md
          retention-days: 30